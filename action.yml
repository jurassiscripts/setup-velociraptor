name: Setup Velociraptor
description: Install Velociraptor scripts manager
author: JurassiScripts
branding:
  icon: terminal
  color: blue
inputs:
  checkout:
    description: Whether to checkout repository first
    default: true
    required: false
  deno-version:
    description: Deno version to use
    default: 1.x
    required: false
  velociraptor-version:
    description: Velociraptor version to use
    default: latest
    required: false
  velociraptor-alias:
    description: Velociraptor alias name
    default: vr
    required: false
outputs:
  deno-is-canary:
    description: Whether installed Deno version is a canary version
  deno-version:
    description: Deno version that was installed
  velociraptor-version:
    description: Velociraptor version that was installed
runs:
  using: composite
  steps:
    - name: run actions/checkout@v2
      uses: actions/checkout@v2
      if: ${{ inputs.checkout }}
    - name: run denoland/setup-deno@v1
      uses: denoland/setup-deno@v1
      if: ${{ inputs.deno-version }}
      with: 
        deno-version: ${{ inputs.deno-version }}
    - name: setup velociraptor
      shell: bash
      run: |
        case "${{ inputs.velociraptor-version }}" in
          "latest") ;; "") ;;
          *) VERSION=@${{ inputs.velociraptor-version }} ;;
        esac
        deno install --allow-all --name ${{ inputs.velociraptor-alias }} https://deno.land/x/velociraptor$VERSION/cli.ts
        echo "/home/runner/.deno/bin" >> $GITHUB_PATH
    - name: add velociraptor to path (macos)
      shell: bash
      if: ${{ contains(runner.os, 'macos') }}
      run: |
        echo "/Users/runner/.deno/bin" >> $GITHUB_PATH
    - name: add velociraptor to path (windows)
      shell: powershell
      if: ${{ contains(runner.os, 'windows') }}
      run: |
        echo "C:\Users\runneradmin\.deno\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: compute outputs
      shell: bash
      run: |
        DENO_CANARY=false 
        DENO_RELEASE_TYPE=$(deno --version | grep -Po '(?<=\()(?:canary|release)(?=,)')
        DENO_VERSION=$(deno --version | grep -Po '(?<=deno )\d+\.\d+\.\d+')
        VELOCIRAPTOR_VERSION=$(${{ inputs.velociraptor-alias }} --version)
        if [ "$DENO_RELEASE_TYPE" = "canary" ]
        then
          DENO_CANARY=true
        fi

        echo "DENO_CANARY: $DENO_CANARY"
        echo "DENO_VERSION: $DENO_VERSION"
        echo "VELOCIRAPTOR_VERSION: $VELOCIRAPTOR_VERSION"
        echo "::set-output name=deno-version::(echo $DENO_VERSION)"
        echo "::set-output name=deno-is-canary::(echo $DENO_CANARY)"
        echo "::set-output name=velociraptor-version::(echo $VELOCIRAPTOR_VERSION)"